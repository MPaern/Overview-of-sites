---
title: "Overview of data collected in the field season of 2024 for coastal monitoring"
author: "Maris Pärn"
format:
  html:
    embed-resources: true
editor: visual
---

```{r setup}
#| echo: false
#| warning: false

#setup

library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(MetBrewer)
library(hms)
library(leaflet.minicharts)
library(leaflet)
library(tidyr)
library(zoo)
library(circular)


# read necessary data in

overview_summary <- read.csv("overview_2024.csv")
cm <- read.csv("cm_all_2024.csv") # has to be in the folder
missing_dates <- read.csv("Missing dates v4.csv")
missing_2024 <- read.csv("2024_missing_vetted.csv")

```

## Summary of 2024

![](images/DSC05850.JPG)

### Year in numbers

Number of detectors: 50\

Number of detectors that survived the season: 48\

Reasons of detector failure: Water damage by humans, seawater damage by other forces\

Date of first deployment: `r min(overview_summary$date_deployed)`\

Date of last deployment: `r max(overview_summary$date_deployed)`\

Date of first retrieval: `r min(overview_summary$date_retrieved)`\

Date of last retrieval: `r max(overview_summary$date_retrieved)`\

Days detectors were on the field: 4908\

Days with missing data: 318\

\% of missing data from all data: ca 6,5\

Reasons of missing data:\

1\) No bats, no noise detected (later Nodata): 19\

2\) SD card full: 238\

3\) Batteries empty: 23\

4\) Detector dead: 33\

Average time detector deployed: `r mean(overview_summary$days_active)`\

```{r preparing missing dates data}
#| echo: false
#| warning: false

complete_dates <- overview_summary |>  
  mutate(
    BeginDate = as.Date(date_deployed),
    EndDate   = as.Date(date_retrieved) - 1,
    full_dates = map2(BeginDate, EndDate, ~ seq.Date(from = .x, to = .y, by = "day"))
  ) |> 
  select(Site, full_dates) |> 
  unnest(full_dates) |> 
  rename(ExpectedDate = full_dates)

available_dates <- cm %>%
  mutate(ActualDate = as.Date(DATE.12)) %>%
  reframe(ActualDate = unique(ActualDate), .by = "Site")

available_dates <- available_dates %>%
  mutate(Type = "Observed")

missing_dates$X <- NULL

missing_dates <- missing_dates %>%
  rename(
    Date = ExpectedDate
  )

available_dates <- available_dates %>%
  rename(
    Date = ActualDate
  )

missing_dates <- missing_dates %>%
  mutate(Type = "Missing") %>% 
  mutate(Date=ymd(Date))


all_dates <- bind_rows(available_dates, missing_dates)
```

```{r data preparation for plots in this document}
#| echo: false
#| warning: false

# missing dates plot
  # add type NoData (aka no recordings) to Observed and Missing

missing_2024 <- missing_2024 %>%
  mutate(ExpectedDate=mdy(ExpectedDate))

NoData <-  missing_2024 |> 
  filter(Battery.status == "OK", SD.card.status == "OK") |> 
  select(Site, ExpectedDate) |> 
  rename(
    Date = ExpectedDate
  ) |> 
  data.frame(Type = "NoData")

all_dates <- all_dates |> 
  left_join(NoData, by = c("Site", "Date"), suffix = c("", "_new")) |> 
  mutate(Type = if_else(!is.na(Type_new), Type_new, Type)) |> 
  select(-Type_new)

# noise plot

noise_coast <- cm[,c(13,16)]
noise_coast$type <- overview_summary$type[match(noise_coast$Site, overview_summary$Site)]

# autoid plot

auto_id_data <- cm[,c(10,13, 15, 16)]
auto_id_data$type <- overview_summary$type[match(auto_id_data$Site, overview_summary$Site)]

# combined bat calls plot

cm <- cm %>%
  mutate(DATE.12=ymd(DATE.12))

# activity plot
  # adding a column "type"

cm$type <- overview_summary$type[match(cm$Site, overview_summary$Site)]


```

```{r pnat data preparation}
#| echo: false
#| warning: false

# choose PIPNAT

cm_pnat <- cm %>%
  filter(autoid == "PIPNAT") 

cm_pnat_c <- cm_pnat |>
  filter(type == "coast") %>%
  filter(month(DATE.12) %in% c(8, 9, 10))

# add median dates

median_dates_all <- cm_pnat %>%
  group_by(Site) %>%
  summarise(median = median(DATE.12, na.rm = TRUE))

median_dates_all$latitude <-overview_summary$latitude[match(median_dates_all$Site, overview_summary$Site)]

median_dates_all <- median_dates_all %>%
  arrange(latitude) %>%
  mutate(Site = factor(Site, levels = Site))

cm_pnat_c <- cm_pnat_c %>%
  mutate(TIME=as_hms(TIME))

cm_pnat_c <- cm_pnat_c %>%
  mutate(TIME.12=as_hms(TIME.12))


# median(cm_pnat_c$DATE.12, na.rm = FALSE)

median_dates <- cm_pnat_c %>%
  group_by(Site) %>%
  summarise(median = median(DATE.12, na.rm = TRUE))

median_dates$latitude <-overview_summary$latitude[match(median_dates$Site, overview_summary$Site)]

median_dates <- median_dates %>%
  arrange(latitude) %>%
  mutate(Site = factor(Site, levels = Site))

cm_pnat_c <- cm_pnat_c %>%
  mutate(TIME=as_hms(TIME))

cm_pnat_c <- cm_pnat_c %>%
  mutate(TIME.12=as_hms(TIME.12))

# half a month

cm_pnat_c <- cm_pnat_c %>%
  mutate(
    HalfMonth = case_when(
      lubridate::day(DATE) <= 15 ~
        paste0(lubridate::year(DATE), "-", sprintf("%02d", lubridate::month(DATE)), "-H1"),
      TRUE ~
        paste0(lubridate::year(DATE), "-", sprintf("%02d", lubridate::month(DATE)), "-H2")
    )
  )

#check for duplicates
  #dim(cm_pnat_c[duplicated(cm_pnat_c$filename),])[1]

# 

```

## Deployment times

This is a graph that shows the days with missing data and how long the detectors were in the field.

```{r missing dates plot}
#| echo: false
#| label: fig-missing
#| warning: false
#| fig-cap: Missing dates 2024

ggplot(all_dates, aes(x = Date, y = Site, color = Type)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Observed" = "azure3", "NoData" = "darkgrey", "Missing" = "red")) +
  theme_minimal() +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  labs(title = "Observed and Missing Dates for 2024")


```

## Noise

@fig-noise Shows the proportion of noise in all the sites. We can see that some of the sites are a lot noisier than others. Coastal sites tend to have more noise, but it varies from 20% (CM-27, sheltered by Kvassheim lighthouse) to 99% (Utsira-2). From lakesites, the most noise was 78% (CM-14, lake in Lista) and the least 11% (CM-34, guitarmuseum).

```{r noise figure 1}
#| echo: false
#| label: fig-noise
#| warning: false
#| fig-cap: Proportion of noise on sites

ggplot(cm) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

```{r noise figures 2-4}
#| echo: false
#| eval: false
#| label: fig-noise-compare
#| warning: false
#| fig-cap: Comparison of noise in different sites
#| fig-subcap:
#| - "Noise on coast"
#| - "Noise around lakes"
#| - "Noise inland"
#| layout-ncol: 3
#| column: page

ggplot(subset(noise_coast, type == "coast")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(subset(noise_coast, type == "lake")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(subset(noise_coast, type == "inland")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

If we look at the total amount of 5 second recordings on @fig-total, then the amount of noise varies less, with CM-12 (coast near Lista) being an extra noisy location. The best overview of how locations differ gives @fig-noisecall. We can see that the number of recordings we can work with is times bigger in lake sites than in coastal sites.

In terms of how to distribute sites to different classes, I have made a third, "inland" class that doesn't really fit under the two others, with CM-01 (Utsira lighthouse), CM-07 (Raulemyra) and CM-41 (NMBU campus). Coastal sites are sites up to 400m from the coast, the furthest away being CM-25 near Brusand with 380 meters. There is also one lake site that falls into the 400m cutoff, CM-34 (Guitarmuseum) that is 280m from the coast. As for the inland sites, CM-01 is 600m from the coast and 480m from a freshwater lake, CM-07 is 9000m from the coast and 230m from a bigger freshwater source (wider part of a stream), CM-41 is 2230m from the coast and 100m from a bigger freshwater source (wider part of a stream).

```{r noise figure 5}
#| echo: false
#| label: fig-total
#| warning: false
#| fig-cap: Amount of recordings and noise

# the amount of noise stays the same, some places have just more bats?

ggplot(noise_coast) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid == "Noise"), width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Number of 5s recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()



```

```{r noise figure 6}
#| echo: false
#| label: fig-noisecall
#| warning: false
#| fig-cap: Correlation between recordings and the amount of noise

ggplot(overview_summary) +
  aes(x = `noise_pct`, y = `batcalls`, colour = type) +
  geom_point(size = 3.35, 
             shape = "diamond") +
  scale_color_viridis_d(option = "cividis", direction = 1) +
  labs(x = "Percentage of noise files in recordings", 
       y = "Number of recordings with bat calls", title = "Correlation between noise and bat calls", subtitle = "By location") +
  theme_classic() +
  theme(legend.text = element_text(face = "bold"), legend.title = element_text(face = "bold"))
```

## AUTO-ID bats

While the combined auto-id @fig-autoid doesn't give us a very detailed picture of what species are present, we can still get a proxy of the amount of recordings and species from it. When we compare the coast and the lakes, we can see that the amount of calls differs a lot (@fig-autoid-compare).\
Out of the top 4 coastal locations, top 2 are next to big rivers (Obrestad Prestegård, Brusand), third one is a fjord that looks like a lake (Framvaren) and fourth one is very sheltered from the sea (Stapnes bedehus).\
CM-46 is the only lake site in a wind farm, but the low number of detections may be due to other reasons.

```{r auto-id figure}
#| echo: false
#| label: fig-autoid
#| warning: false
#| fig-cap: Amount of bat calls

ggplot(auto_id_data %>% filter(autoid != "Noise")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  coord_flip() +
  theme(text = element_text(size = 10)) + 
  theme_minimal()

```

```{r autoid 3 plots}
#| echo: false
#| label: fig-autoid-compare
#| warning: false
#| fig-cap: Comparison of autoid in different sites
#| fig-subcap:
#| - "AutoID on coast"
#| - "AutoID around lakes"
#| - "AutoID inland"
#| layout-ncol: 3
#| column: page

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "coast")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "lake")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "inland")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

## Timing of calls

We can see on @fig-bat-calls that in September, the total amount of calls recorded starts to drop. We have to bear in mind here that the beginning and end of the graph is lower because the detectors were put up and taken down not all at once.

```{r combined plot}
#| echo: false
#| label: fig-bat-calls
#| warning: false
#| fig-cap: Amount of bat calls

ggplot(cm %>% 
    filter(autoid != "Noise") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()


```

```{r activity 3 plots}
#| echo: false
#| label: fig-activity-compare
#| warning: false
#| include: false
#| fig-cap: Comparison of activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page

ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()
  
ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()
```

### Northern bat activity

We can see a high level of avtivity throughout the recording period up until the beginning of september, when activity suddenly drops.

```{r enil}
#| echo: false
#| label: fig-enil
#| warning: false
#| fig-cap: AUTO-ID Enil calls

ggplot(cm %>% 
    filter(autoid == "EPTNIL") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()


```

```{r enil 3}
#| echo: false
#| label: fig-enil-3
#| warning: false
#| fig-cap: Comparison of Enil activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page


ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

```

### Nathusius' pipistrelle activity

We can see that in our sites, the activity peaks in September.

```{r pnat}
#| echo: false
#| label: fig-pnat
#| warning: false
#| fig-cap: Pnat calls

ggplot(cm %>% 
    filter(autoid == "PIPNAT") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall amount of calls") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

```{r pnat 3}
#| echo: false
#| label: fig-pnat-3
#| warning: false
#| fig-cap: Comparison of Pnat activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page


ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

### Soprano pipistrelle activity

Activity is higher leading up to the September peak, but we can still clearly see a peak that occurs earlier than that of Nathusius’ pipistrelles.

```{r ppyg}
#| echo: false
#| label: fig-ppyg
#| warning: false
#| fig-cap: Ppyg calls


ggplot(cm %>% 
    filter(autoid == "PIPPYG") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

```{r ppyg 3}
#| echo: false
#| label: fig-ppyg-3
#| warning: false
#| fig-cap: Comparison of Ppyg activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

### Daubentons' bat activity

```{r mdau}
#| echo: false
#| label: fig-mdau
#| warning: false
#| fig-cap: Mdau calls

ggplot(cm %>% 
    filter(autoid == "PIPPYG") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "skyblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

## Nathusius' pipistrelle distribution

On the study area, some sites had clearly higher amounts of nathusius' pipistrelles. On the @fig-pnat-map below, we can see how many 5s clips of Auto-ID Pnat we had per site.

```{r pnat map}
#| echo: false
#| label: fig-pnat-map
#| warning: false
#| fig-cap: Number of Pnat calls per site

tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"

basemap <- leaflet(width = "100%", height = "400px") %>%
  addTiles(tilesURL)

basemap %>%
  addMinicharts(
    overview_summary$longitude, overview_summary$latitude,
    chartdata = overview_summary$pnatcalls, 
    showLabels = TRUE,
    width = 45
  )
```

The median date of activity did not differ that much based on the location, as is seen on @fig-pnat-ns below.

```{r pnat lat map}
#| echo: false
#| eval: false
#| label: fig-pnat-map-ns
#| warning: false
#| fig-cap: Timing of Pnat calls per site

# data per day for recordings by site 
pnat_day <- cm_pnat %>%
  count(Site, DATE.12) %>%      # counts rows for each combination
  pivot_wider(
    names_from = DATE.12,
    values_from = n,
    values_fill = 0             # fill missing with 0
  )

# Reorder date columns
date_cols <- setdiff(names(pnat_day), "Site")  # All columns except site

# Convert column names to Date
ordered_cols <- date_cols[order(as.Date(date_cols))]

# Rebuild data frame with columns in date order
pnat_day <- pnat_day %>%
  select(Site, all_of(ordered_cols))

# add columns lat and long
pnat_day$lat <- overview_summary$latitude[match(pnat_day$Site, overview_summary$Site)]
pnat_day$long <- overview_summary$longitude[match(pnat_day$Site, overview_summary$Site)]

newdf <- pnat_day %>% select(-Site, -lat, -long)



basemap %>%
  addMinicharts(pnat_day$long, pnat_day$lat,
    chartdata= newdf,
    width = 45, height = 45
  )


```

```{r pnat lat}
#| echo: false
#| label: fig-pnat-ns
#| warning: false
#| fig-cap: Median date of Pnat calls per site

# remove sites that have no data in Sept: 33, 37,47,48

median_dates_all <- median_dates_all %>%
  filter(!Site %in% c("CM-33", "CM-37", "CM-47", "CM-48"))

ggplot(median_dates_all) +
  aes(x = `median`, y = `Site`) +
  geom_point(size = 3.35, 
             shape = "diamond", colour = "darkblue") +
  labs(x = "Median activity date", 
       y = "Site", title = "Median activity by site", subtitle = "From N to S") +
  theme_classic() +
  theme(legend.text = element_text(face = "bold"), legend.title = element_text(face = "bold"))

```

```{r diur act pnat}
#| eval: false
#| echo: false
#| warning: false

# what time of day is there more activity in the coastal sites?

ggplot(cm_pnat_c) +
  aes(x = DATE.12) +
  geom_histogram(bins = 30L, fill = "#112446") +
  theme_minimal() +
  facet_wrap(vars(Site))

cm_pnat_c %>%
 filter(DATE.12 >= "2024-08-01" & DATE.12 <= "2024-10-15") %>%
 ggplot() +
  aes(x = HOUR.12) +
  geom_histogram(bins = 30L, fill = "#112446") +
  theme_minimal() +
  facet_wrap(vars(DATE))

cm_pnat_c %>%
  filter(DATE.12 >= "2024-08-01",
         DATE.12 <= "2024-10-15") %>%
  ggplot(aes(x = HOUR.12)) +
  geom_histogram(bins = 30, fill = "#112446") +
  theme_minimal() +
  facet_wrap(vars(HalfMonth))

```




## Weather data 

```{r setup}
#| echo: false
#| warning: false

# read necessary data in

weather <- read.csv("WeatherData2024.csv")

# fix df, remove NA-s

weather$X <- NULL
weather$Unnamed..0 <- NULL
weather$Unnamed..0.1 <- NULL

summary(weather)

weather <- na.omit(weather)

summary(weather)

```

```{r interpolation of data}
# for temperature, pressure, cloud area, humidity and wind speed, I'll use linear interpolation

# create a column with datetime format

weather <- weather %>%
  mutate(datetime = make_datetime(
    year = year,  
    month = month,
    day = day,
    hour = hour
  ))

missing_time <- make_datetime(2024, 8, 20, 22)

weather_full <- weather %>%
  group_by(name) %>%
  tidyr::complete(datetime = c(datetime, missing_time)) %>%
  ungroup()

linear_vars <- c(
  "air_temperature_2m",
  "air_pressure_at_sea_level",
  "cloud_area_fraction",
  "relative_humidity_2m",
  "wind_speed_10m"
)


weather_full <- weather_full %>%
  group_by(name) %>%
  arrange(datetime) %>%
  mutate(across(
    all_of(linear_vars),
    ~ na.approx(., x = datetime, na.rm = FALSE)
  ))

# for wind direction, I'll use circular interpolation

weather_full <- weather_full %>%
  mutate(
    wd_rad = wind_direction_10m * pi / 180,
    u = sin(wd_rad),
    v = cos(wd_rad)
  )

weather_full <- weather_full %>%
  group_by(name) %>%
  arrange(datetime) %>%
  mutate(across(
    c(u, v),
    ~ zoo::na.approx(., x = as.numeric(datetime), na.rm = FALSE)
  )) %>%
  ungroup()

weather_full <- weather_full %>%
  mutate(
    wind_direction_10m =
      (atan2(u, v) * 180 / pi) %% 360
  ) %>%
  select(-wd_rad, -u, -v)

# precipitation I'll assess based on the values before/after. It seems that the rain stopped before that timepoint, I'll add 0 to everything

weather_full <- weather_full %>%
  mutate(
    precipitation_amount = if_else(
      is.na(precipitation_amount),
      0,
      precipitation_amount
    )
  )

# fill other datarows that have NA-s

weather_full <- weather_full %>%
  mutate(
    year  = year(datetime),
    month = month(datetime),
    day   = day(datetime),
    hour  = hour(datetime)
  )

site_vars <- c("location_latitude", "location_longitude", "nearest_latitude", "nearest_longitude")

weather_full <- weather_full %>%
  group_by(name) %>%
  fill(all_of(site_vars), .direction = "downup") %>%
  ungroup()

```

```{r exploration temp}
weather_full_ns <- weather_full %>%
  arrange(location_latitude) %>%
  mutate(
    name = factor(name, levels = unique(name))
  )

ggplot(weather_full_ns, aes(x = name, y = air_temperature_2m)) +
  geom_boxplot(outlier.alpha = 0.3) +
  theme_bw() +
  labs(x = "Site", y = "Temperature (°C)") +
  theme(axis.text.x = element_text(angle = 90))+
  coord_flip()


temp_summary <- weather_full %>%
  group_by(name) %>%
  summarise(
    mean_temp = mean(air_temperature_2m, na.rm = TRUE),
    sd_temp   = sd(air_temperature_2m, na.rm = TRUE)
  )

library(ggrepel)

ggplot(temp_summary, aes(mean_temp, sd_temp, label = name)) +
  geom_point() +
  geom_text_repel(size = 3, max.overlaps = 50) +
  theme_bw() +
  labs(
    x = "Mean temperature",
    y = "Temperature SD"
  )



```
```{r exploration wind}
wind_summary <- weather_full %>%
  group_by(name) %>%
  summarise(
    max_wind = max(wind_speed_10m, na.rm = TRUE),
    p95_wind = quantile(wind_speed_10m, 0.95, na.rm = TRUE)
  )

ggplot(wind_summary, aes(x = name, y = max_wind)) +
  geom_col() +
  theme_bw() +
  labs(y = "Max wind speed (m/s)") +
  theme(axis.text.x = element_text(angle = 90))


```
```{r exploration}

ggplot(weather_full_ns,
       aes(location_longitude, location_latitude, color = air_temperature_2m)) +
  geom_point() +
  coord_equal() +
  theme_bw()

ggplot(weather_full, aes(cloud_area_fraction)) +
  geom_histogram(bins = 30) +
  theme_bw()

library(openair)

windRose(
  weather_full,
  ws = "wind_speed_10m",
  wd = "wind_direction_10m",
  facet = "name",
  ncol = 5
)

windRose(
  weather_full,
  ws = "wind_speed_10m",
  wd = "wind_direction_10m",
  facet = "name",
  ncol = 5,
  angle = 30
)

windRose(
  subset(weather_full, month %in% c(6, 7, 8)),
  ws = "wind_speed_10m",
  wd = "wind_direction_10m",
  facet = "name",
  ncol = 5
)

windRose(
  subset(weather_full, month %in% c(9, 10)),
  ws = "wind_speed_10m",
  wd = "wind_direction_10m",
  facet = "name",
  ncol = 5
)

wind_dir_summary <- weather_full %>%
  group_by(name) %>%
  summarise(
    mean_dir = as.numeric(
      mean(circular(wind_direction_10m,
                     units = "degrees",
                     modulo = "2pi"),
           na.rm = TRUE)
    )
  )

ggplot(wind_summary,
       aes(x = name, y = 0,
           xend = name,
           yend = mean_speed)) +
  geom_segment(
    arrow = arrow(length = unit(0.25, "cm")),
    linewidth = 0.8
  ) +
  coord_flip() +
  theme_bw() +
  labs(
    y = "Mean wind vector magnitude",
    x = "Site",
    title = "Dominant wind direction and strength by site"
  )
  )

ggplot(wind_summary,
       aes(x = location_longitude,
           y = location_latitude)) +
  geom_segment(
    aes(
      xend = location_longitude + u_bar * 0.2,
      yend = location_latitude  + v_bar * 0.2
    ),
    arrow = arrow(length = unit(0.25, "cm")),
    linewidth = 0.8
  ) +
  coord_equal() +
  theme_bw() +
  labs(
    x = "Longitude",
    y = "Latitude",
    title = "Dominant wind direction by site"
  )

wind_uv <- weather_full %>%
  mutate(
    u = sin(wind_direction_10m * pi / 180) * wind_speed_10m,
    v = cos(wind_direction_10m * pi / 180) * wind_speed_10m
  ) %>%
  group_by(name) %>%
  summarise(
    u_bar = mean(u, na.rm = TRUE),
    v_bar = mean(v, na.rm = TRUE)
  ) %>%
  mutate(
    mean_speed = sqrt(u_bar^2 + v_bar^2),
    mean_dir   = (atan2(u_bar, v_bar) * 180 / pi) %% 360
  )

ggplot(wind_uv,
       aes(x = name, y = 0,
           xend = name,
           yend = mean_speed)) +
  geom_segment(arrow = arrow(length = unit(0.2, "cm"))) +
  coord_flip()

```

