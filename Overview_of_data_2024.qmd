---
title: "Overview of data collected in the field season of 2024 for coastal monitoring"
author: "Maris PÃ¤rn"
format: html
editor: visual
---

```{r}
#| echo: false
#| warning: false

#setup

library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(MetBrewer)

# read necessary data in

overview_summary <- read.csv("overview_2024.csv")
cm <- read.csv("cm_all_2024.csv")
missing_dates <- read.csv("Missing dates v4.csv")

```

## Summary of 2024

![](images/DSC05850.JPG)

### Year in numbers

Number of detectors: 50\

Number of detectors that survived the season: 48\

Reasons of detector failure: Water damage by humans, seawater damage by other forces\

Date of first deployment:`r min(overview_summary$date_deployed)`\

Date of last deployment:`r max(overview_summary$date_deployed)`\

Date of first retrieval: `r min(overview_summary$date_retrieved)`\

Date of last retrieval: `r max(overview_summary$date_retrieved)`\

Days detectors were on the field: 4908\

Days with missing data: 320 or 319\

\% of missing data from all data: ca 6,5\

Reasons of missing data:\

1\) No bats, no noise detected: 19\

2\) SD card full: 238\

Batteries empty: 23\

Detector dead: 33\

Average time detector deployed: `r mean(overview_summary$days_active)`\

## Deployment times 

This is a graph that shows the days with missing data and how long the detectors were in the field.

```{r preparing missing dates data}
#| echo: false
#| warning: false

complete_dates <- overview_summary |>  
  mutate(
    BeginDate = as.Date(date_deployed),
    EndDate   = as.Date(date_retrieved) - 1,
    full_dates = map2(BeginDate, EndDate, ~ seq.Date(from = .x, to = .y, by = "day"))
  ) |> 
  select(Site, full_dates) |> 
  unnest(full_dates) |> 
  rename(ExpectedDate = full_dates)

available_dates <- cm %>%
  mutate(ActualDate = as.Date(DATE.12)) %>%
  reframe(ActualDate = unique(ActualDate), .by = "Site")

available_dates <- available_dates %>%
  mutate(Type = "Observed")

missing_dates$X <- NULL

missing_dates <- missing_dates %>%
  rename(
    Date = ExpectedDate
  )

available_dates <- available_dates %>%
  rename(
    Date = ActualDate
  )

missing_dates <- missing_dates %>%
  mutate(Type = "Missing") %>% 
  mutate(Date=ymd(Date))


all_dates <- bind_rows(available_dates, missing_dates)
```


```{r missing dates plot} 
#| echo: false
#| label: fig-missing
#| warning: false
#| fig-cap: Misisng dates 2024
#| column: page

ggplot(all_dates, aes(x = Date, y = Site, color = Type)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Observed" = "darkgrey", "Missing" = "red")) +
  theme_minimal() +
  labs(title = "Observed and Missing Dates for 2024")

```

## Noise

@fig-noise Shows the proportion of noise in all the sites. We can see that some of the sites are a lot noisier than others and @fig-noise-compare shows that coastal sites tend to have more noise. 

```{r noise figure 1}
#| echo: false
#| label: fig-noise
#| warning: false
#| fig-cap: Proportion of noise on sites

ggplot(cm) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

```{r noise figures 2-4}
#| echo: false
#| label: fig-noise-compare
#| warning: false
#| fig-cap: Comparison of noise in different sites
#| fig-subcap:
#| - "Noise on coast"
#| - "Noise around lakes"
#| - "Noise inland"
#| layout-ncol: 3
#| column: page


noise_coast <- cm[,c(13,16)]
noise_coast$type <- overview_summary$type[match(noise_coast$Site, overview_summary$Site)]

ggplot(subset(noise_coast, type == "coast")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(subset(noise_coast, type == "lake")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(subset(noise_coast, type == "inland")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

If we look at the total amount of 5 second recordings on @fig-total , then the amount of noise varies less, with CM-12 being an extra noisy location. The best overview of how locations differ gives @fig-noisecall. We can see that the number of recordings we can work with is times bigger in lake sites than in coastal sites.

```{r noise figure 5}
#| echo: false
#| label: fig-total
#| warning: false
#| fig-cap: Amount of recordings and noise

# the amount of noise stays the same, some places have just more bats?

ggplot(noise_coast) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid == "Noise"), width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Number of 5s recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()



```

```{r noise figure 6}
#| echo: false
#| label: fig-noisecall
#| warning: false
#| fig-cap: Correlation between recordings and the amount of noise

ggplot(overview_summary) +
  aes(x = `noise_pct`, y = `batcalls`, colour = type) +
  geom_point(size = 3.35, 
             shape = "diamond") +
  scale_color_viridis_d(option = "cividis", direction = 1) +
  labs(x = "Percentage of noise files in recordings", 
       y = "Number of recordings with bat calls", title = "Correlation between noise and bat calls", subtitle = "By location") +
  theme_classic() +
  theme(legend.text = element_text(face = "bold"), legend.title = element_text(face = "bold"))
```

## AUTO-ID bats

While the combined auto-id says little about what species are present in what locations, mostly because auto-id is not reliable, then some species-specific auto-ids will give quite a good picture of the species' movements. 

```{r auto-id figure}
#| echo: false
#| label: fig-autoid
#| warning: false
#| fig-cap: Amount of bat calls

auto_id_data <- cm[,c(10,13, 15, 16)]
auto_id_data$type <- overview_summary$type[match(auto_id_data$Site, overview_summary$Site)]

ggplot(auto_id_data %>% filter(autoid != "Noise")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  coord_flip() +
  theme(text = element_text(size = 10)) + 
  theme_minimal()

```
```{r autoid 3 plots}
#| echo: false
#| label: fig-autoid-compare
#| warning: false
#| fig-cap: Comparison of autoid in different sites
#| fig-subcap:
#| - "AutoID on coast"
#| - "AutoID around lakes"
#| - "AutoID inland"
#| layout-ncol: 3
#| column: page

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "coast")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "lake")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "inland")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```


```{r}
# enil plot
# ppyg plot
# pnat plot
# mdau plot?


```

## Pnat activity

```{r}
# N-S location based
# coastal vs lakes
# 



```
