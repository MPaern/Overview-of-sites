---
title: "Overview of data collected in the field season of 2024 for coastal monitoring"
author: "Maris Pärn"
format: html
editor: visual
---

```{r}
#| echo: false
#| warning: false

#setup

library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(MetBrewer)

# read necessary data in

overview_summary <- read.csv("overview_2024.csv")
cm <- read.csv("cm_all_2024.csv")
missing_dates <- read.csv("Missing dates v4.csv")

```

## Summary of 2024

![](images/DSC05850.JPG)

### Year in numbers

Number of detectors: 50\

Number of detectors that survived the season: 48\

Reasons of detector failure: Water damage by humans, seawater damage by other forces\

Date of first deployment:`r min(overview_summary$date_deployed)`\

Date of last deployment:`r max(overview_summary$date_deployed)`\

Date of first retrieval: `r min(overview_summary$date_retrieved)`\

Date of last retrieval: `r max(overview_summary$date_retrieved)`\

Days detectors were on the field: 4908\

Days with missing data: 320 or 319\

\% of missing data from all data: ca 6,5\

Reasons of missing data:\

1\) No bats, no noise detected: 19\

2\) SD card full: 238\

Batteries empty: 23\

Detector dead: 33\

Average time detector deployed: `r mean(overview_summary$days_active)`\

## Deployment times 

This is a graph that shows the days with missing data and how long the detectors were in the field.

```{r preparing missing dates data}
#| echo: false
#| warning: false

complete_dates <- overview_summary |>  
  mutate(
    BeginDate = as.Date(date_deployed),
    EndDate   = as.Date(date_retrieved) - 1,
    full_dates = map2(BeginDate, EndDate, ~ seq.Date(from = .x, to = .y, by = "day"))
  ) |> 
  select(Site, full_dates) |> 
  unnest(full_dates) |> 
  rename(ExpectedDate = full_dates)

available_dates <- cm %>%
  mutate(ActualDate = as.Date(DATE.12)) %>%
  reframe(ActualDate = unique(ActualDate), .by = "Site")

available_dates <- available_dates %>%
  mutate(Type = "Observed")

missing_dates$X <- NULL

missing_dates <- missing_dates %>%
  rename(
    Date = ExpectedDate
  )

available_dates <- available_dates %>%
  rename(
    Date = ActualDate
  )

missing_dates <- missing_dates %>%
  mutate(Type = "Missing") %>% 
  mutate(Date=ymd(Date))


all_dates <- bind_rows(available_dates, missing_dates)
```


```{r missing dates plot} 
#| echo: false
#| label: fig-missing
#| warning: false
#| fig-cap: Misisng dates 2024
#| column: page

ggplot(all_dates, aes(x = Date, y = Site, color = Type)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Observed" = "darkgrey", "Missing" = "red")) +
  theme_minimal() +
  labs(title = "Observed and Missing Dates for 2024")

```

## Noise

@fig-noise Shows the proportion of noise in all the sites. We can see that some of the sites are a lot noisier than others and @fig-noise-compare shows that coastal sites tend to have more noise. 

```{r noise figure 1}
#| echo: false
#| label: fig-noise
#| warning: false
#| fig-cap: Proportion of noise on sites

ggplot(cm) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

```{r noise figures 2-4}
#| echo: false
#| label: fig-noise-compare
#| warning: false
#| fig-cap: Comparison of noise in different sites
#| fig-subcap:
#| - "Noise on coast"
#| - "Noise around lakes"
#| - "Noise inland"
#| layout-ncol: 3
#| column: page


noise_coast <- cm[,c(13,16)]
noise_coast$type <- overview_summary$type[match(noise_coast$Site, overview_summary$Site)]

ggplot(subset(noise_coast, type == "coast")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(subset(noise_coast, type == "lake")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(subset(noise_coast, type == "inland")) + 
  geom_bar(aes(x= reorder(Site, autoid == "Noise", FUN = mean), fill = autoid == "Noise"), position = "fill", width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

If we look at the total amount of 5 second recordings on @fig-total , then the amount of noise varies less, with CM-12 being an extra noisy location. The best overview of how locations differ gives @fig-noisecall. We can see that the number of recordings we can work with is times bigger in lake sites than in coastal sites. 

In terms of how to distribute sites to different classes, I have made a third, "inland" class that doesn't really fit under the two others, with CM-01 (Utsira lighthouse), CM-07 (Raulemyra) and CM-41 (NMBU campus). Coastal sites are sites up to 400m from the coast, the furthest away being CM-25 near Brusand with 380 meters. There is also one lake site that falls into the 400m cutoff, CM-34 (Guitarmuseum) that is 280m from the coast. 
As for the inland sites, CM-01 is 600m from the coast and 480m from a freshwater lake, CM-07 is 9000m from the coast and 230m from a bigger freshwater source, CM-41 is 2230m from the coast and 100m from a bigger freshwater source. 


```{r noise figure 5}
#| echo: false
#| label: fig-total
#| warning: false
#| fig-cap: Amount of recordings and noise

# the amount of noise stays the same, some places have just more bats?

ggplot(noise_coast) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid == "Noise"), width = 0.9) +
  scale_fill_manual(name = "AutoID", values = c("TRUE" = "royalblue4", "FALSE" = "olivedrab3"), labels = c("Auto-ID bat calls", "Noise")) +
  ylab("Number of 5s recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()



```

```{r noise figure 6}
#| echo: false
#| label: fig-noisecall
#| warning: false
#| fig-cap: Correlation between recordings and the amount of noise

ggplot(overview_summary) +
  aes(x = `noise_pct`, y = `batcalls`, colour = type) +
  geom_point(size = 3.35, 
             shape = "diamond") +
  scale_color_viridis_d(option = "cividis", direction = 1) +
  labs(x = "Percentage of noise files in recordings", 
       y = "Number of recordings with bat calls", title = "Correlation between noise and bat calls", subtitle = "By location") +
  theme_classic() +
  theme(legend.text = element_text(face = "bold"), legend.title = element_text(face = "bold"))
```

## AUTO-ID bats

While the combined auto-id @fig-autoid doesn't give us a very detailed picture of what species are present, we can still get a proxy of the amount of recordings and species from it. When we compare the coast and the lakes, we can see that the amount of calls differs a lot (@fig-autoid-compare). Out of the top 4 coastal locations, top 2 are next to big rivers (Obrestad Prestegård, Brusand), third one is a fjord that looks like a lake (Framvaren) and fourth one is very sheltered from the sea (Stapnes bedehus).

```{r auto-id figure}
#| echo: false
#| label: fig-autoid
#| warning: false
#| fig-cap: Amount of bat calls

auto_id_data <- cm[,c(10,13, 15, 16)]
auto_id_data$type <- overview_summary$type[match(auto_id_data$Site, overview_summary$Site)]

ggplot(auto_id_data %>% filter(autoid != "Noise")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Number of 5s KPRO files") + 
  xlab("Site") +
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  coord_flip() +
  theme(text = element_text(size = 10)) + 
  theme_minimal()

```

```{r autoid 3 plots}
#| echo: false
#| label: fig-autoid-compare
#| warning: false
#| fig-cap: Comparison of autoid in different sites
#| fig-subcap:
#| - "AutoID on coast"
#| - "AutoID around lakes"
#| - "AutoID inland"
#| layout-ncol: 3
#| column: page

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "coast")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "lake")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()
  
ggplot(auto_id_data %>% 
  filter(autoid != "Noise",
          type == "inland")) + 
  geom_bar(aes(x= reorder(Site, table(Site)[Site]), fill = autoid)) +
  scale_fill_manual(name = "AutoID", values = met.brewer("Signac", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 10)) +
  coord_flip() + 
  scale_x_discrete(expand = expansion(mult = c(0.01, 0.01)))+
  theme_minimal()

```

## Occurrance of calls

We can see on @fig-bat-calls that in September, the amount of calls recorded, starts to drop. The very beginning of the graph and end on the graph show that not all the detectors were out, that's why the amount of calls was lower. 

```{r combined plot}
#| echo: false
#| label: fig-bat-calls
#| warning: false
#| fig-cap: Amount of bat calls

cm <- cm %>%
  mutate(DATE.12=ymd(DATE.12))

ggplot(cm %>% 
    filter(autoid != "Noise") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()


```

```{r activity 3 plots}
#| echo: false
#| label: fig-activity-compare
#| warning: false
#| include: false
#| fig-cap: Comparison of activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page

# adding a column "type"
cm$type <- overview_summary$type[match(cm$Site, overview_summary$Site)]

ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()
  
ggplot(cm %>% 
    filter(autoid != "Noise",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "#3FA750") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()
```

Over all the sites, the northern bat activity 

```{r enil}
#| echo: false
#| label: fig-enil
#| warning: false
#| fig-cap: Enil calls

ggplot(cm %>% 
    filter(autoid == "EPTNIL") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()


```
```{r enil 3}
#| echo: false
#| label: fig-enil-3
#| warning: false
#| fig-cap: Comparison of Enil activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page


ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "EPTNIL",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "purple") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", , date_labels = "%b") +
    theme_minimal()

```

Over all the sites, the nathusius' pipistrelle activity 

```{r pnat}
#| echo: false
#| label: fig-pnat
#| warning: false
#| fig-cap: Pnat calls

ggplot(cm %>% 
    filter(autoid == "PIPNAT") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

```{r pnat 3}
#| echo: false
#| label: fig-pnat-3
#| warning: false
#| fig-cap: Comparison of Pnat activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page


ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPNAT",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "royalblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```
Over all the sites, the soprano pipistrelle activity 

```{r ppyg}
#| echo: false
#| label: fig-ppyg
#| warning: false
#| fig-cap: Ppyg calls


ggplot(cm %>% 
    filter(autoid == "PIPPYG") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

```{r ppyg 3}
#| echo: false
#| label: fig-ppyg-3
#| warning: false
#| fig-cap: Comparison of Ppyg activity in different sites
#| fig-subcap:
#| - "Activity on coast"
#| - "Activity around lakes"
#| - "Activity inland"
#| layout-ncol: 3
#| column: page

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "coast") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity on the coast") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "lake") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity around lakes") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()

ggplot(cm %>% 
    filter(autoid == "PIPPYG",
            type == "inland") %>%
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "pink4") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity inland") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```
Over all the sites, the daubentons' bat activity 

```{r mdau}
#| echo: false
#| label: fig-mdau
#| warning: false
#| fig-cap: Mdau calls

ggplot(cm %>% 
    filter(autoid == "PIPPYG") %>% 
    droplevels(), aes(x= DATE.12, color = taxa)) + 
  stat_count( geom = "point", size= 4, alpha = 0.90, color = "skyblue") +
    ylab("Recordings per night") + xlab("Month") +
   ggtitle("Overall activity") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    theme_minimal()
```

Nathusius' pipistrelle activity on the coast N to S by median activity in August and September. 

```{r pnat lat}

# choose PIPNAT

cm_pnat <- cm %>%
  filter(autoid == "PIPNAT") %>%
  filter(type == "coast") %>%
  filter(month(DATE.12) %in% c(8, 9))

# add median dates

median(cm_pnat$DATE.12, na.rm = FALSE)

median_dates <- cm_pnat %>%
  group_by(Site) %>%
  summarise(median = median(DATE.12, na.rm = TRUE))

median_dates$latitude <-overview_summary$latitude[match(median_dates$Site, overview_summary$Site)]

median_dates <- median_dates %>%
  arrange(latitude) %>%
  mutate(Site = factor(Site, levels = Site))

ggplot(median_dates) +
  aes(x = `median`, y = `Site`) +
  geom_point(size = 3.35, 
             shape = "diamond") +
  scale_color_viridis_d(option = "cividis", direction = 1) +
  labs(x = "Median activity date", 
       y = "Site from N to S", title = "Activity in Aug-Sept", subtitle = "By location") +
  theme_classic() +
  theme(legend.text = element_text(face = "bold"), legend.title = element_text(face = "bold"))

```
